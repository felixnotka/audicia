---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.1
  name: audiciapolicyreports.audicia.io
spec:
  group: audicia.io
  names:
    kind: AudiciaPolicyReport
    listKind: AudiciaPolicyReportList
    plural: audiciapolicyreports
    shortNames:
    - apr
    - apreport
    singular: audiciapolicyreport
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.subject.name
      name: Subject
      type: string
    - jsonPath: .spec.subject.kind
      name: Kind
      type: string
    - jsonPath: .status.compliance.severity
      name: Compliance
      type: string
    - jsonPath: .status.compliance.score
      name: Score
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    - description: RBAC rules actually exercised
      jsonPath: .status.compliance.usedCount
      name: Needed
      priority: 1
      type: integer
    - description: RBAC rules granted but never used
      jsonPath: .status.compliance.excessCount
      name: Excess
      priority: 1
      type: integer
    - description: observed actions without RBAC grant
      jsonPath: .status.compliance.uncoveredCount
      name: Ungranted
      priority: 1
      type: integer
    - description: excess grants on sensitive resources
      jsonPath: .status.compliance.hasSensitiveExcess
      name: Sensitive
      priority: 1
      type: boolean
    - description: total audit events processed
      jsonPath: .status.eventsProcessed
      name: Audit Events
      priority: 1
      type: integer
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          AudiciaPolicyReport contains the observed RBAC rules and suggested policies
          for a single subject, generated by the Audicia operator.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              AudiciaPolicyReportSpec defines the identity context for a policy report.
              This contains the subject the report covers. Set once when created.
            properties:
              subject:
                description: Subject identifies who this report is about.
                properties:
                  kind:
                    description: Kind is the type of subject (ServiceAccount, User,
                      or Group).
                    enum:
                    - ServiceAccount
                    - User
                    - Group
                    type: string
                  name:
                    description: Name is the name of the subject.
                    minLength: 1
                    type: string
                  namespace:
                    description: Namespace is the namespace of the subject (only for
                      ServiceAccount).
                    type: string
                required:
                - kind
                - name
                type: object
            required:
            - subject
            type: object
          status:
            description: AudiciaPolicyReportStatus contains all operator-generated
              output.
            properties:
              compliance:
                description: |-
                  Compliance contains the RBAC drift analysis comparing observed usage
                  against the subject's effective permissions in the cluster.
                properties:
                  excessCount:
                    description: ExcessCount is the number of effective RBAC rules
                      that were never observed in use.
                    format: int32
                    type: integer
                  excessRules:
                    description: ExcessRules lists effective RBAC rules that were
                      never observed in use.
                    items:
                      description: ComplianceRule describes a single RBAC permission
                        used in excess/uncovered lists.
                      properties:
                        apiGroups:
                          description: APIGroups is the list of API groups for this
                            rule.
                          items:
                            type: string
                          type: array
                        namespace:
                          description: |-
                            Namespace is the namespace this rule applies in.
                            Empty for cluster-scoped rules.
                          type: string
                        nonResourceURLs:
                          description: NonResourceURLs is the list of non-resource
                            URLs (e.g., "/metrics").
                          items:
                            type: string
                          type: array
                        resources:
                          description: Resources is the list of resources.
                          items:
                            type: string
                          type: array
                        verbs:
                          description: Verbs is the list of verbs.
                          items:
                            type: string
                          type: array
                      required:
                      - apiGroups
                      - resources
                      - verbs
                      type: object
                    type: array
                  hasSensitiveExcess:
                    description: |-
                      HasSensitiveExcess is true when excess RBAC grants include sensitive
                      resources (secrets, nodes, webhookconfigurations, etc.).
                    type: boolean
                  lastEvaluatedTime:
                    description: LastEvaluatedTime is when the compliance check was
                      last run.
                    format: date-time
                    type: string
                  score:
                    description: |-
                      Score is the ratio of used effective rules to total effective rules,
                      expressed as a percentage (0-100). A score of 100 means every granted
                      permission was actually exercised by at least one observed action.
                    format: int32
                    type: integer
                  sensitiveExcess:
                    description: |-
                      SensitiveExcess lists excess RBAC grants on sensitive resources
                      (e.g., secrets, nodes, webhookconfigurations).
                    items:
                      type: string
                    type: array
                  severity:
                    description: 'Severity is the compliance level: Green (score >=
                      80), Yellow (>= 50), Red (< 50).'
                    enum:
                    - Green
                    - Yellow
                    - Red
                    type: string
                  uncoveredCount:
                    description: |-
                      UncoveredCount is the number of observed rules NOT covered by any existing RBAC grant.
                      These represent permissions being used without explicit RBAC authorization
                      (possible via aggregated ClusterRoles or other mechanisms not yet resolved).
                    format: int32
                    type: integer
                  uncoveredRules:
                    description: UncoveredRules lists observed actions not covered
                      by any effective RBAC grant.
                    items:
                      description: ComplianceRule describes a single RBAC permission
                        used in excess/uncovered lists.
                      properties:
                        apiGroups:
                          description: APIGroups is the list of API groups for this
                            rule.
                          items:
                            type: string
                          type: array
                        namespace:
                          description: |-
                            Namespace is the namespace this rule applies in.
                            Empty for cluster-scoped rules.
                          type: string
                        nonResourceURLs:
                          description: NonResourceURLs is the list of non-resource
                            URLs (e.g., "/metrics").
                          items:
                            type: string
                          type: array
                        resources:
                          description: Resources is the list of resources.
                          items:
                            type: string
                          type: array
                        verbs:
                          description: Verbs is the list of verbs.
                          items:
                            type: string
                          type: array
                      required:
                      - apiGroups
                      - resources
                      - verbs
                      type: object
                    type: array
                  usedCount:
                    description: |-
                      UsedCount is the number of effective RBAC rules that were exercised by
                      at least one observed action.
                    format: int32
                    type: integer
                required:
                - excessCount
                - lastEvaluatedTime
                - score
                - severity
                - uncoveredCount
                - usedCount
                type: object
              conditions:
                description: Conditions represent the latest available observations
                  of the report's state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              eventsProcessed:
                description: EventsProcessed is the total number of audit events that
                  contributed to this report.
                format: int64
                type: integer
              lastProcessedTime:
                description: LastProcessedTime is the timestamp of the last processed
                  event for this subject.
                format: date-time
                type: string
              observedRules:
                description: ObservedRules is the structured list of observed RBAC
                  rules for this subject.
                items:
                  description: ObservedRule represents a single observed RBAC rule
                    with metadata.
                  properties:
                    apiGroups:
                      description: APIGroups is the list of API groups for this rule.
                      items:
                        type: string
                      type: array
                    count:
                      description: Count is the number of times this rule was observed.
                      format: int64
                      minimum: 1
                      type: integer
                    firstSeen:
                      description: FirstSeen is when this rule was first observed.
                      format: date-time
                      type: string
                    lastSeen:
                      description: LastSeen is when this rule was last observed.
                      format: date-time
                      type: string
                    namespace:
                      description: |-
                        Namespace is the namespace where this rule was observed.
                        Empty for cluster-scoped resources or non-resource URLs.
                      type: string
                    nonResourceURLs:
                      description: |-
                        NonResourceURLs is the list of non-resource URLs (e.g., "/metrics").
                        Mutually exclusive with APIGroups/Resources.
                      items:
                        type: string
                      type: array
                    resources:
                      description: Resources is the list of resources (including subresources
                        like "pods/exec").
                      items:
                        type: string
                      type: array
                    verbs:
                      description: Verbs is the list of verbs observed.
                      items:
                        type: string
                      type: array
                  required:
                  - apiGroups
                  - count
                  - firstSeen
                  - lastSeen
                  - resources
                  - verbs
                  type: object
                type: array
              suggestedPolicy:
                description: SuggestedPolicy contains rendered RBAC manifests ready
                  for kubectl apply.
                properties:
                  manifests:
                    description: |-
                      Manifests is a list of rendered YAML strings, each containing a complete
                      Role, ClusterRole, RoleBinding, or ClusterRoleBinding manifest.
                    items:
                      type: string
                    type: array
                required:
                - manifests
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
